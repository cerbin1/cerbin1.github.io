<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Minesweeper</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<button class="new-game-button" onclick="startGame()">Start new game</button>
<label for="numberOfBombs"></label><input type="number" id="numberOfBombs" value="10">
    <label for="width"></label><input type="number" id="width" value="10">
    <label for="length"></label><input type="number" id="length" value="10">
<!--<script>
    var d = document.getElementById("d");
    d.addEventListener("click", function () {

    });
</script>-->

<script>
    var width;
    var length;
    var numberOfBombs;
    var isGameDone = false;
    var colors = ["blue", "green", "red", "purple", "orange", "pink"];
    var cells;

    function startGame() {
        width = document.getElementById("width").value;
        length = document.getElementById("length").value;
        numberOfBombs = document.getElementById("numberOfBombs").value;
        cells = fillTwoDimensionalArray();
        createBorderTable();
        plantBombs();
        createPicture();
    }



    function createPicture() {
        var image = document.createElement("img");
        image.src = "baby.png";
        image.setAttribute("class", "picture");
        image.setAttribute("onclick", "startGame()");
        document.body.appendChild(image);
    }

    function fillTwoDimensionalArray() {
        var array = [];
        for (var i = 0; i < width; i++) {
            array[i] = [];
            for (var j = 0; j < length; j++) {
                array[i][j] = getDefaultFieldObject();
            }
        }
        return array;
    }

    function getDefaultFieldObject() {
        return {isBomb: false, isFlag: false, numberOfBombsAdjacent: 0, gameField: null, isCellDiscovered: false};
    }

    function createBorderTable() {
        var gameDiv = document.createElement("div");
        gameDiv.setAttribute("oncontextmenu", "return false");
        document.body.appendChild(gameDiv);

        var table = document.createElement("table");
        table.setAttribute("id", "gameBoard");
        gameDiv.appendChild(table);

        for (var i = 0; i < width; i++) {
            var row = document.createElement("tr");
            row.setAttribute("id", "row" + i.toString());
            table.appendChild(row);

            for (var j = 0; j < length; j++) {
                var cell = document.createElement("td");
                cell.setAttribute("onmousedown", "playerMove(event, this)");
                cell.setAttribute("data-x", i.toString());
                cell.setAttribute("data-y", j.toString());
                row.appendChild(cell);
                cells[i][j].gameField = cell;
            }
        }
    }

    function plantBombs() {
        for (var i = 0; i < numberOfBombs; i++) {
            while (true) {
                var x = Math.floor(Math.random() * cells.length);
                var y = Math.floor(Math.random() * cells.length);
                if (!cells[x][y].isBomb) {
                    cells[x][y].isBomb = true;
                    break;
                }
            }
        }
        countBombsAdjacentToFields();
    }

    function countBombsAdjacentToFields() {
        for (var i = 0; i < cells.length; i++) {
            for (var j = 0; j < cells[i].length; j++) {
                isBombAdjacentToField(i, j);
            }
        }
//        displayAllBombs();
    }

    function isBombAdjacentToField(x, y) {
        for (var i = -1; i < 2; i++) {
            for (var j = -1; j < 2; j++) {
                if (x + i >= 0 && x + i <= width - 1 && y + j >= 0 && y + j <= length - 1) {
                    if (cells[x + i][y + j].isBomb) {
                        incrementNumberOfBombsAdjacentToField(x, y);
                    }
                }
            }
        }
    }

    function incrementNumberOfBombsAdjacentToField(x, y) {
        cells[x][y].numberOfBombsAdjacent++;
    }

    function playerMove(event, object) {
        if (!isGameDone) {
            var x = parseInt(object.getAttribute("data-x"));
            var y = parseInt(object.getAttribute("data-y"));

            if (event.button == 0) {
                discoverField(x, y, cells[x][y]);
            }
            if (event.button == 2) {
                setFlag(cells[x][y]);
            }
            checkIfPlayerWins();
        }
        else {
            console.log("rozpocznij nowa gre");
        }
    }

    function discoverField(x, y, cellToDiscover) {
        if (!cellToDiscover.isFlag) {
            if (!cellToDiscover.isCellDiscovered) {
                if (cellToDiscover.isBomb) {
                    displayAllBombs();
                    console.log("Przegrales");
                    isGameDone = true;
                } else {
                    if (cellToDiscover.numberOfBombsAdjacent > 0) {
                        cellToDiscover.gameField.innerText = cellToDiscover.numberOfBombsAdjacent;
                        cellToDiscover.gameField.style.color = colorNumberOfBombs(cellToDiscover.numberOfBombsAdjacent);
                        cellToDiscover.gameField.style.backgroundColor = "darkGray";
                        cellToDiscover.isCellDiscovered = true;
                    } else {
                        floodFill(x, y);
                    }
                }
            }
        }
    }

    function setFlag(cellToSetFlag) {
        var flagImage = document.createElement("img");
        if (!cellToSetFlag.isCellDiscovered) {
            if (cellToSetFlag.isFlag) {
                cellToSetFlag.gameField.innerHTML = "";
                flagImage.src = "";
                cellToSetFlag.isFlag = false;
            } else {
                flagImage.src = "flag.png";
                cellToSetFlag.isFlag = true;
            }
            cellToSetFlag.gameField.appendChild(flagImage);
        }
    }

    function displayAllBombs() {
        for (var i = 0; i < cells.length; i++) {
            for (var j = 0; j < cells[i].length; j++) {
                if (cells[i][j].isBomb) {
                    cells[i][j].gameField.style.backgroundColor = "red";
                }
            }
        }
    }

    function checkIfPlayerWins() {
        if (countPointsFromFlags() == numberOfBombs || countFieldsUndiscovered() == 0) {
            console.log("wygrales");
            isGameDone = true;
        } else {
            console.log("punkty z flag: " + countPointsFromFlags() + " punkty z pol " + countFieldsUndiscovered());
        }
    }

    function countPointsFromFlags() {
        var numberOfPoints = 0;
        for (var i = 0; i < width; i++) {
            for (var j = 0; j < length; j++) {
                if (cells[i][j].isBomb && cells[i][j].isFlag) {
                    numberOfPoints++;
                }
                if (!cells[i][j].isBomb && cells[i][j].isFlag) {
                    numberOfPoints--;
                }
            }
        }
        return numberOfPoints;
    }

    function countFieldsUndiscovered() {
        var numberOfUndiscoveredFields = 0;
        for (var i = 0; i < width; i++) {
            for (var j = 0; j < length; j++) {
                if (!cells[i][j].isBomb && !cells[i][j].isCellDiscovered) {
                    numberOfUndiscoveredFields++;
                }
            }
        }
        return numberOfUndiscoveredFields;
    }

    function colorNumberOfBombs(numberOfBombs) {
        return colors[numberOfBombs - 1];
    }

    function floodFill(x, y) {
        if (y < 0 || y > width - 1 || x < 0 || x > length - 1 || cells[x][y].isFlag || cells[x][y].isBomb) {
            return;
        }

        var cell = cells[x][y];

        if (cell.isCellDiscovered) {
            return;
        }

        if (cell.numberOfBombsAdjacent > 0) {
            cell.gameField.innerHTML = cell.numberOfBombsAdjacent.toString();
            cell.gameField.style.color = colorNumberOfBombs(cell.numberOfBombsAdjacent);
            cell.gameField.style.backgroundColor = "darkGray";
            cell.isCellDiscovered = true;
            return;
        }
        else {
            cell.gameField.style.backgroundColor = "darkGray";
            cell.isCellDiscovered = true;
        }

        for (var i = -1; i < 2; i++) {
            for (var j = -1; j < 2; j++) {
                floodFill(x + i, y + j);
            }
        }
    }

</script>
</body>
</html>